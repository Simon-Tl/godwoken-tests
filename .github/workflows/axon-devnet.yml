name: Contract Tests on Axon

on:
  push:
  schedule:
  - cron:  '50 0 * * *' # every 24 hour
jobs:
  contract-test-on-axon:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        path: godwoken-tests
          #submodules: 'recursive'

    - uses: actions/setup-node@v3
      with:
        node-version: '18'
    - name: Get yarn cache directory path
      id: yarn-cache-dir-path
      run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT
    - name: Node Cache
      uses: actions/cache@v3
      id: npm-and-yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
      with:
        path: |
          ${{ steps.yarn-cache-dir-path.outputs.dir }}
          ~/.npm
        key: ${{ runner.os }}-node_modules-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-node_modules-
    - uses: actions/checkout@v3
      with:
        repository: axonweb3/axon 
        path: axon
    - uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
    - name: Install Rust components
      run: rustup component add rustfmt && rustup component add clippy
    - name: Deploy Local Network of Axon
      working-directory: axon
      run: |
        echo "Build axon"
        cargo build
        rm -rf ./devtools/chain/data
        ./target/debug/axon --config devtools/chain/config.toml --genesis devtools/chain/genesis_single_node.json > /tmp/log 2>&1 &
        echo "Sleep a while"
        sleep 5
        tail /tmp/log
    - name: Test | Run internal contract tests
      working-directory: godwoken-tests/contracts
      run: |
        npm install
        npx hardhat run scripts/before-axon-devnet.js --network axon_devnet
        npx hardhat test --network axon_devnet

